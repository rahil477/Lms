{% extends 'base.html' %}
{% load i18n %}
{% block title %} {% trans 'Dashboard' %} | {% trans 'Learning management system' %} {% endblock title %}
{% load static %}

{% block header %}
{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans 'Dashboard' %}</li>
    </ol>
</nav>

{% include 'snippets/messages.html' %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="title-1">{% trans 'Dashboard' %}</h1>
    <div class="dropdown">
        <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu">
            <h6 class="dropdown-header">{% trans 'Dashboard settings' %}</h6>
            <button class="dropdown-item active" type="button">{% trans 'Display grid' %}</button>
            <button class="dropdown-item" type="button">{% trans 'Display table' %}</button>
            <hr>
            <button class="dropdown-item" type="button">{% trans 'Manage dashboard' %}</button>
        </div>
    </div>
</div>

{% if request.user.is_superuser %}
<!-- Existing Admin Dashboard -->
<div class="row users-count px-3">
    <div class="col-12 col-sm-6 col-lg-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-aqua"></i></h3>
            <div class="text-right">
                {% trans 'Students' %}
                <h2>{{ student_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-orange"></i></h3>
            <div class="text-right">
                {% trans 'Lecturers' %}
                <h2>{{ lecturer_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-red"></i></h3>
            <div class="text-right">
                {% trans 'Administrators' %}
                <h2>{{ superuser_count }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row px-2">
    <div class="col-md-6 p-2">
        <div class="chart-wrap">
            <i class="fas fa-expand-alt"></i>
            <canvas id="traffic"></canvas>
        </div>
    </div>
    <div class="col-md-6 p-2">
        <div class="chart-wrap">
            <i class="fas fa-expand-alt"></i>
            <canvas id="enrollement"></canvas>
        </div>
    </div>
    <div class="col-12 col-xl-6 p-2">
        <div class="card w-100 h-100 p-3 shadow-sm border-0">
            <h5>{% trans 'Latest activities' %}</h5>
            <div class="overflow-auto" style="max-height: 400px;">
                <ul class="ps-2 small">
                    {% for log in logs %}
                    <li class="mb-2">{{ log.message }} <span class="text-muted small">- {{ log.created_at|timesince }}
                            {% trans 'ago' %}</span></li>
                    {% empty %}
                    <li>{% trans 'No recent activity' %}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

{% elif request.user.is_student %}
<!-- Student Dashboard -->
<div class="row mb-4 px-3">
    <div class="col-md-12">
        <div class="card shadow-sm border-0 p-4 bg-primary text-white">
            <h4>{% trans 'Welcome back,' %} {{ student.student.get_full_name }}!</h4>
            <p class="mb-0">{% trans 'Level:' %} {{ student.level }} | {% trans 'Program:' %} {{ student.program.title
                }}</p>
        </div>
    </div>
</div>

<div class="row px-3">
    <!-- Course Statistics -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-dark fw-bold">{% trans 'My Courses & Performance' %}</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>{% trans 'Course' %}</th>
                                <th>{% trans 'Attendance' %}</th>
                                <th>{% trans 'Current Grade' %}</th>
                                <th>{% trans 'Action' %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tc in taken_courses %}
                            <tr>
                                <td class="text-start ps-3">
                                    <div class="fw-bold">{{ tc.course.title }}</div>
                                    <div class="small text-muted">{{ tc.course.code }}</div>
                                </td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {% if tc.attendance_percentage < 75 %}bg-danger{% else %}bg-success{% endif %}"
                                            role="progressbar" style="width: {{ tc.attendance_percentage }}%"></div>
                                    </div>
                                    <small class="{% if tc.attendance_percentage < 75 %}text-danger fw-bold{% endif %}">
                                        {{ tc.attendance_percentage|stringformat:".1f" }}%
                                    </small>
                                </td>
                                <td>
                                    <span class="badge rounded-pill bg-light text-dark border p-2">
                                        {{ tc.get_total|stringformat:".2f" }} / 100
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'course_detail' tc.course.slug %}"
                                        class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">{% trans 'No registered courses.' %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Widgets -->
    <div class="col-lg-4">
        <!-- Pending Assignments -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-warning text-dark py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-clock me-2"></i>{% trans 'Pending Assignments' %}</h6>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for ass in pending_assignments %}
                    <li class="list-group-item px-0 py-3">
                        <a href="{% url 'assignment_submit' ass.course.slug ass.id %}"
                            class="text-decoration-none text-dark d-block">
                            <div class="fw-bold">{{ ass.title }}</div>
                            <small class="text-danger"><i class="fas fa-calendar-times me-1"></i>Due: {{
                                ass.due_date|date:"d M, H:i" }}</small>
                        </a>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted small px-0">{% trans 'All caught up!' %}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-bell me-2 text-primary"></i>{% trans 'Recent Notifications' %}
                </h6>
            </div>
            <div class="card-body">
                {% for n in unread_notifications %}
                <div class="mb-3 pb-2 border-bottom">
                    <div class="small fw-bold">{{ n.verb }}</div>
                    <div class="small text-muted">{{ n.description|truncatechars:60 }}</div>
                </div>
                {% empty %}
                <p class="text-muted small">{% trans 'No unread notifications.' %}</p>
                {% endfor %}
                <a href="{% url 'notifications' %}" class="btn btn-sm btn-link p-0 text-primary">{% trans 'View all'
                    %}</a>
            </div>
        </div>
    </div>
</div>

{% elif request.user.is_lecturer %}
<!-- Lecturer Dashboard - Specialties & Groups Grid -->
<div class="row px-3">
    <div class="col-12">
        <h4 class="mb-4">{% trans 'İxtisaslar və Qruplar' %}</h4>
    </div>
    {% for specialty in specialties %}
    <div class="col-12 mb-4">
        <h5 class="border-bottom pb-2 mb-3 text-secondary">{{ specialty.title }}</h5>
        <div class="row">
            {% for group in groups %}
            {% if group.program == specialty %}
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm border-0 specialty-card overflow-hidden"
                    style="background-color: #7986cb;">
                    <div class="card-body p-4 text-white position-relative">
                        <i class="fas fa-info-circle position-absolute top-0 start-0 m-3 opacity-50"></i>
                        <h5 class="card-title mt-2 fw-bold">{{ specialty.title }}</h5>
                        <p class="card-text small opacity-75">{{ group.title }}</p>
                    </div>
                    <div class="card-footer bg-dark bg-opacity-25 border-0 text-end py-2">
                        <a href="{% url 'group_detail' group.id %}"
                            class="text-white text-decoration-none small stretched-link">
                            {% trans 'Fənnə gir' %} <i class="fas fa-arrow-circle-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">{% trans 'Hələ ki, sizə heç bir qrup təhkim edilməyib.' %}</div>
    </div>
    {% endfor %}
</div>

<style>
    .specialty-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .specialty-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
    }
</style>
{% endif %}
<br>
<div class="bg-white p-3">
    <h5 class="border-bottom pb-2">{% trans 'School Demographics' %}</h5>
    <div class="row">
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <canvas id="gender"></canvas>
        </div>
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <canvas id="ethnicity"></canvas>
        </div>
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <canvas id="language"></canvas>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}

<script src="{% url 'javascript-catalog' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
    $('.fa-expand-alt').click(function () {
        if ($(this).parent('.chart-wrap').parent('.col-md-6').hasClass('expand')) {
            $('.col-md-6.expand').removeClass('expand');
        }
        else {
            $('.col-md-6.expand')?.removeClass('expand');
            $(this).parent('.chart-wrap').parent('.col-md-6').addClass('expand');
        }
    })
</script>
{{ males_count|default:"0"|json_script:"malesCount" }}
{{ females_count|default:"0"|json_script:"femalesCount" }}
{{ bachelor_count|default:"0"|json_script:"bachelorCount" }}
{{ master_count|default:"0"|json_script:"masterCount" }}

<script>
    const malesCount = JSON.parse(document.getElementById('malesCount').textContent);
    const femalesCount = JSON.parse(document.getElementById('femalesCount').textContent);
    const bachelorCount = JSON.parse(document.getElementById('bachelorCount').textContent);
    const masterCount = JSON.parse(document.getElementById('masterCount').textContent);

    $(document).ready(function () {

        // Setup
        const labels = [
            gettext('January'),
            gettext('February'),
            gettext('March'),
            gettext('April'),
            gettext('May'),
            gettext('June'),
        ];
        const data = {
            labels: labels,
            datasets: [{
                label: gettext('Students'),
                backgroundColor: 'rgba(86, 224, 224, 0.5)',
                borderColor: 'rgb(86, 224, 224)',
                hoverBorderWidth: 3,
                data: [0, 10, 5, 2, 20, 30, 45]
            }, {
                label: gettext('Teachers'),
                backgroundColor: 'rgba(253, 174, 28, 0.5)',
                borderColor: 'rgb(253, 174, 28)',
                hoverBorderWidth: 3,
                data: [20, 0, 15, 4, 6, 4, 60],
            }, {
                label: gettext('Admins'),
                backgroundColor: 'rgba(203, 31, 255, 0.5)',
                borderColor: 'rgb(203, 31, 255)',
                hoverBorderWidth: 3,
                data: [85, 30, 34, 20, 20, 55, 45],
            }, {
                label: gettext('Stuffs'),
                backgroundColor: 'rgba(255, 19, 157, 0.5)',
                borderColor: 'rgb(255, 19, 157)',
                hoverBorderWidth: 3,
                data: [45, 75, 70, 80, 20, 30, 90],
            }]
        };

        var traffic = document.getElementById('traffic');
        var chart = new Chart(traffic, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Website Traffic'),
                        padding: 15
                    }
                }
            }
        });

        // Setup
        const labelsEnrollment = [
            '2016',
            '2017',
            '2018',
            '2019',
            '2020',
            '2021',
        ];
        const dataEnrollment = {
            labels: labelsEnrollment,
            datasets: [{
                label: gettext('Comp.S'),
                backgroundColor: 'rgba(86, 224, 224, 0.5)',
                borderColor: 'rgb(86, 224, 224)',
                hoverBorderWidth: 3,
                data: [0, 10, 5, 2, 20, 30, 45]
            }, {
                label: gettext('Architecture'),
                backgroundColor: 'rgba(253, 174, 28, 0.5)',
                borderColor: 'rgb(253, 174, 28)',
                hoverBorderWidth: 3,
                data: [20, 0, 15, 4, 6, 4, 60],
            }, {
                label: gettext('Civil Eng'),
                backgroundColor: 'rgba(203, 31, 255, 0.5)',
                borderColor: 'rgb(203, 31, 255)',
                hoverBorderWidth: 3,
                data: [85, 30, 34, 20, 20, 55, 45],
            }, {
                label: gettext('Accounting'),
                backgroundColor: 'rgba(255, 19, 157, 0.5)',
                borderColor: 'rgb(255, 19, 157)',
                hoverBorderWidth: 3,
                data: [45, 75, 70, 80, 20, 30, 90],
            }, {
                label: gettext('Business M.'),
                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                borderColor: 'rgb(0, 0, 0)',
                hoverBorderWidth: 3,
                data: [15, 75, 45, 90, 60, 30, 90],
            }]
        };

        var enrollement = document.getElementById('enrollement');
        var chart = new Chart(enrollement, {
            type: 'bar',
            data: dataEnrollment,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Enrollment per course'),
                        padding: 20
                    }
                }
            }
        });

        // Average grade setup
        const labelsGrade = [
            '2017',
            '2018',
            '2019',
            '2020',
            '2022',
        ];
        const dataGrade = {
            labels: labelsGrade,
            datasets: [{
                label: gettext("Comp sci."),
                backgroundColor: 'rgba(86, 224, 224, 0.5)',
                borderColor: 'rgb(86, 224, 224)',
                hoverBorderWidth: 3,
                data: [0, 10, 5, 2, 20, 30, 45]
            }, {
                label: gettext("Civil eng."),
                backgroundColor: 'rgba(253, 174, 28, 0.5)',
                borderColor: 'rgb(253, 174, 28)',
                hoverBorderWidth: 3,
                data: [20, 0, 15, 4, 6, 4, 60],
            }, {
                label: gettext("Architect."),
                backgroundColor: 'rgba(203, 31, 255, 0.5)',
                borderColor: 'rgb(203, 31, 255)',
                hoverBorderWidth: 3,
                data: [85, 30, 34, 20, 20, 55, 45],
            }, {
                label: gettext("Economics"),
                backgroundColor: 'rgba(255, 19, 157, 0.5)',
                borderColor: 'rgb(255, 19, 157)',
                hoverBorderWidth: 3,
                data: [45, 75, 70, 80, 20, 30, 90],
            }]
        };

        var students_grade = document.getElementById('students_grade');
        var chart = new Chart(students_grade, {
            type: 'bar',
            data: dataGrade,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Students average grade (performance)'),
                        padding: 20
                    }
                }
            }
        });

        const dataGender = {
            labels: [
                gettext('Man'),
                gettext('Women')
            ],
            datasets: [{
                label: gettext("Students Gender Dataset"),
                data: [malesCount, femalesCount],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)'
                ],
                hoverOffset: 4
            }]
        };

        var gender = document.getElementById('gender');
        var chart = new Chart(gender, {
            type: 'pie',
            data: dataGender,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Students Gender'),
                        padding: 20
                    }
                }
            }
        });

        const dataQualification = {
            labels: [
                gettext('PHD'),
                gettext('Masters'),
                gettext('BSc degree')
            ],
            datasets: [{
                label: gettext("Lecturer Qualifications Dataset"),
                data: [24, 30, 26],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 193, 7)',
                    'rgb(54, 162, 235)'
                ],
                hoverOffset: 4
            }]
        };
        var ethnicity = document.getElementById('ethnicity');
        var chart = new Chart(ethnicity, {
            type: 'pie',
            data: dataQualification,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Lecturer qualifications'),
                        padding: 20
                    }
                }
            }
        });

        const dataLevels = {
            labels: [
                gettext('PHD'),
                gettext('Masters'),
                gettext('BSc degree')
            ],
            datasets: [{
                label: gettext("Students level"),
                data: [0, masterCount, bachelorCount],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 193, 7)',
                    'rgb(54, 162, 235)'
                ],
                hoverOffset: 4
            }]
        };
        var language = document.getElementById('language');
        var chart = new Chart(language, {
            type: 'pie',
            data: dataLevels,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: gettext('Student levels'),
                        padding: 20
                    }
                }
            }
        });
    })

</script>

{% endblock %}